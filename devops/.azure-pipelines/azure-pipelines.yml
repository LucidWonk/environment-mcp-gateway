# MCP Gateway CI/CD Pipeline
# Automatically builds, tests, and deploys MCP server + DevOps tools to ubuntu-devops.lan

trigger:
  branches:
    include:
    - master
    - main
  paths:
    include:
    - EnvironmentMCPGateway/*
    - docker-compose*
    - devops/*
    exclude:
    - README.md
    - docs/*

variables:
  DEVOPS_SERVER: 'ubuntu-devops.lan'
  DEVOPS_USER: 'alex'  # Updated to match your SSH user
  CONTAINER_REGISTRY: 'your-registry'  # Update if using custom registry

stages:
- stage: BuildAndTest
  displayName: 'Build and Test MCP Server'
  jobs:
  - job: BuildJob
    displayName: 'Build MCP Gateway'
    pool: Default
    
    steps:
    - checkout: self
      displayName: 'Checkout Repository'
      
    - task: NodeTool@0
      displayName: 'Setup Node.js'
      inputs:
        versionSpec: '20.x'
        
    - script: |
        cd EnvironmentMCPGateway
        npm ci
        npm run build
        npm run lint
      displayName: 'Build TypeScript MCP Server'
      
    - task: UseDotNet@2
      displayName: 'Setup .NET 9'
      inputs:
        packageType: 'sdk'
        version: '9.x'
        
    - script: |
        dotnet build LucidwonksMCPGateway.sln
        dotnet test EnvironmentMCPGateway.Tests/ --logger trx --results-directory TestResults --filter "FullyQualifiedName~Unit"
      displayName: 'Build and Test .NET Components (Unit Tests Only)'
      
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/TestResults/*.trx'
      condition: always()
      
    - script: |
        cd EnvironmentMCPGateway
        docker build -f docker/Dockerfile -t mcp-gateway:$(Build.BuildId) .
      displayName: 'Build Docker Image'
      
    - script: |
        docker save mcp-gateway:$(Build.BuildId) | gzip > mcp-gateway-$(Build.BuildId).tar.gz
      displayName: 'Export Docker Image'
      
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Docker Image'
      inputs:
        pathtoPublish: 'mcp-gateway-$(Build.BuildId).tar.gz'
        artifactName: 'docker-image'

- stage: Deploy
  displayName: 'Deploy to ubuntu-devops.lan'
  dependsOn: BuildAndTest
  condition: succeeded()
  jobs:
  - deployment: DeployJob
    displayName: 'Deploy MCP Server and Update DevOps Tools'
    environment: 'ubuntu-devops-lan'
    pool: Default
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: docker-image
            
          - task: CopyFilesOverSSH@0
            displayName: 'Copy Docker Image to Server'
            inputs:
              sshEndpoint: 'ubuntu-devops-ssh'  # Configure this service connection
              sourceFolder: '$(Pipeline.Workspace)/docker-image'
              contents: '*.tar.gz'
              targetFolder: '/tmp/mcp-deploy'
              
          - task: CopyFilesOverSSH@0
            displayName: 'Copy Deployment Files'
            inputs:
              sshEndpoint: 'ubuntu-devops-ssh'
              sourceFolder: '$(Build.SourcesDirectory)'
              contents: |
                docker-compose.production.yml
                .env.production
              targetFolder: '/opt/mcp-gateway'
              
          - task: SSH@0
            displayName: 'Deploy MCP Server and Update Bytebase'
            continueOnError: false
            inputs:
              sshEndpoint: 'ubuntu-devops-ssh'
              runOptions: 'commands'
              failOnStderr: false
              commands: |
                # Debug: Check deployment directory exists and is accessible
                echo "Checking /opt/mcp-gateway directory:"
                ls -la /opt/mcp-gateway/ || echo "Cannot access /opt/mcp-gateway"
                
                # Load new MCP server image
                docker load < /tmp/mcp-deploy/mcp-gateway-$(Build.BuildId).tar.gz
                docker tag mcp-gateway:$(Build.BuildId) mcp-gateway:latest
                
                # Update Bytebase to latest version (suppress Docker's normal stderr status messages)
                echo "Pulling latest Bytebase image..."
                docker-compose -f /opt/mcp-gateway/docker-compose.production.yml pull bytebase >/dev/null 2>&1 || true
                echo "Bytebase pull completed"
                
                # Clean up any problematic containers before deployment
                echo "Cleaning up existing containers..."
                docker-compose -f /opt/mcp-gateway/docker-compose.production.yml down --volumes --remove-orphans >/dev/null 2>&1 || true
                docker container prune -f >/dev/null 2>&1 || true
                
                # Deploy with rolling restart
                echo "Starting services with new image..."
                docker-compose -f /opt/mcp-gateway/docker-compose.production.yml up -d
                
                # Wait for services to start
                sleep 15
                
                # Verify deployment
                echo "Checking container status:"
                docker ps
                
                # Clean up
                rm -f /tmp/mcp-deploy/mcp-gateway-$(Build.BuildId).tar.gz
                
          - task: SSH@0
            displayName: 'Health Check Services'
            inputs:
              sshEndpoint: 'ubuntu-devops-ssh'
              runOptions: 'commands'
              commands: |
                # Wait for services to be ready
                sleep 30
                
                # Check MCP Gateway health
                curl -f http://localhost:3002/health || exit 1
                
                # Check Bytebase health  
                curl -f http://localhost:8080/api/ping || exit 1
                
                # Check Portainer health
                curl -f http://localhost:9000/api/system/status || exit 1
                
                echo "All services healthy"